name: Build & Deploy to ECS

on:
  push:
    branches: ["master"]

permissions:
  id-token: write
  contents: read
  checks: write

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
  ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
  ECS_SERVICE: ${{ vars.ECS_SERVICE }}
  ECS_TASK_FAMILY: ${{ vars.ECS_TASK_FAMILY }}
  ECS_CONTAINER_NAME: ${{ vars.ECS_CONTAINER_NAME }}

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven


      - name: Run tests and quality gate
        run: |
          set -o pipefail
          ./mvnw -B -ntp clean verify pitest:mutationCoverage | tee maven.log

      - name: Publish Unit Test Results (Surefire)
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit Tests (Surefire)
          path: target/surefire-reports/TEST-*.xml
          reporter: java-junit

      - name: Publish Integration Test Results (Failsafe)
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Integration Tests (Failsafe)
          path: target/failsafe-reports/TEST-*.xml
          reporter: java-junit

      - name: Upload Surefire reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: surefire-reports
          path: target/surefire-reports

      - name: Upload Failsafe reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: failsafe-reports
          path: target/failsafe-reports

      - name: Upload JaCoCo report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-report
          path: target/site/jacoco

      - name: Upload PIT report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pit-report
          path: target/pit-reports

  deploy:
    needs: test
    if: needs.test.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute image tag
        id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          IMAGE="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${SHORT_SHA}"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build -t "${{ steps.meta.outputs.image }}" .

      - name: Push Docker image
        run: |
          docker push "${{ steps.meta.outputs.image }}"

      - name: Fetch baseline task definition from ECS
        run: |
          aws ecs describe-task-definition \
            --task-definition "${{ vars.ECS_TASK_BASELINE }}" \
            --query taskDefinition \
            --output json > taskdef.current.json

      - name: Clean task definition (remove readonly fields)
        run: |
          jq 'del(
            .taskDefinitionArn,
            .revision,
            .status,
            .requiresAttributes,
            .compatibilities,
            .registeredAt,
            .registeredBy
          )' taskdef.current.json > taskdef.clean.json

      - name: Patch image in task definition (only image)
        run: |
          jq \
            --arg IMG "${{ steps.meta.outputs.image }}" \
            '(.containerDefinitions[] | select(.name=="'"$ECS_CONTAINER_NAME"'") | .image)=$IMG' \
            taskdef.clean.json > taskdef.patched.json

      - name: Register new task definition revision
        id: taskdef
        run: |
          ARN=$(aws ecs register-task-definition \
            --cli-input-json file://taskdef.patched.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "arn=$ARN" >> $GITHUB_OUTPUT

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition "${{ steps.taskdef.outputs.arn }}" \
            --force-new-deployment

      - name: Wait for service stability
        run: |
          aws ecs wait services-stable \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE"
