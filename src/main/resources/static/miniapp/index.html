<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Бюджет</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --bg: #0f1116;
            --text: #ffffff;
            --muted: rgba(255,255,255,.66);
            --muted2: rgba(255,255,255,.50);

            --cardBg1: rgba(255,255,255,.08);
            --cardBg2: rgba(255,255,255,.04);
            --cardBorder: rgba(255,255,255,.14);

            --shadow: 0 14px 34px rgba(0,0,0,.28);
            --radius: 20px;

            --btnBorder: rgba(255,255,255,.18);
            --rowBg: rgba(255,255,255,.05);
            --rowBorder: rgba(255,255,255,.10);
            --statusOk: #6ddcc8;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }

        body {
            margin: 0;
            padding: 18px;

            font-family:
                    "SF Pro Rounded",
                    "SF Pro Display",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    system-ui,
                    sans-serif;

            font-feature-settings: "kern" 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;

            color: var(--text);
            background: var(--bg);
        }

        .bg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background:
                    radial-gradient(900px 700px at 18% -10%, rgba(40,70,255,.35), transparent 60%),
                    radial-gradient(900px 700px at 100% 10%, rgba(0,194,255,.26), transparent 55%),
                    linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,0));
            opacity: 1;
        }

        .wrap {
            position: relative;
            max-width: 560px;
            margin: 0 auto;
            padding: 0;
        }

        .card {
            border-radius: var(--radius);
            border: 1px solid var(--cardBorder);
            background:
                    linear-gradient(140deg, var(--cardBg1), var(--cardBg2)),
                    radial-gradient(120% 120% at 20% 10%, rgba(43,76,255,.40), transparent 55%),
                    radial-gradient(120% 120% at 85% 35%, rgba(0,194,255,.26), transparent 50%);
            box-shadow: var(--shadow);
            padding: 22px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .label {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--muted);
            letter-spacing: .1px;
        }

        .amount {
            margin: 0 0 14px 0;
            font-size: 34px;
            font-weight: 600;
            letter-spacing: -0.25px;
            line-height: 1.08;
        }

        .updated {
            margin: 0 0 18px 0;
            font-size: 13px;
            font-weight: 400;
            color: var(--muted2);
        }

        .btn {
            width: 100%;
            border-radius: 18px;
            padding: 14px;
            font-size: 15px;
            font-weight: 500;
            border: 1px solid var(--btnBorder);
            background: linear-gradient(135deg, rgba(43,76,255,.78), rgba(0,194,255,.52));
            color: #fff;
            cursor: pointer;
            user-select: none;
            transition: transform .08s ease, opacity .12s ease;
        }
        .btn:active { transform: scale(.985); opacity: .92; }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
            color: var(--text);
        }

        .menu {
            margin-top: 12px;
        }

        .menu details {
            position: relative;
        }

        .menu summary {
            list-style: none;
            cursor: pointer;
        }

        .menu summary::-webkit-details-marker { display: none; }

        .menu-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-align: center;
            width: 100%;
        }

        .menu-panel {
            margin-top: 10px;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid var(--rowBorder);
            background: var(--rowBg);
            box-shadow: 0 12px 28px rgba(0,0,0,.18);
            display: flex;
            flex-direction: column;
            gap: 10px;
            animation: menuDrop .18s ease;
        }

        .menu-panel .btn {
            border-radius: 14px;
        }

        @keyframes menuDrop {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .transactions {
            margin-top: 18px;
            padding: 0 2px;
        }

        .transactions-title {
            margin: 0 0 12px;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .tx-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tx-row {
            border-radius: 16px;
            border: 1px solid var(--rowBorder);
            background: var(--rowBg);
            box-shadow: 0 8px 20px rgba(0,0,0,.16);
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .tx-left {
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tx-icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(160deg, #4e7bff, #32b8a6);
            flex-shrink: 0;
        }

        .tx-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tx-sub {
            margin: 1px 0 0;
            font-size: 15px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tx-right {
            text-align: right;
            flex-shrink: 0;
        }

        .tx-amount {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        .tx-empty {
            border-radius: 16px;
            border: 1px dashed var(--rowBorder);
            background: rgba(255,255,255,.03);
            padding: 14px;
            color: var(--muted);
            font-size: 14px;
        }

        .hint {
            margin-top: 12px;
            font-size: 12px;
            color: var(--muted2);
            min-height: 16px;
        }

        body.light {
            --bg: #f4f6f9;
            --text: #101114;
            --muted: rgba(16,17,20,.62);
            --muted2: rgba(16,17,20,.48);

            --cardBg1: rgba(255,255,255,.92);
            --cardBg2: rgba(255,255,255,.86);
            --cardBorder: rgba(0,0,0,.08);

            --shadow: 0 14px 30px rgba(0,0,0,.08);
            --btnBorder: rgba(0,0,0,.08);
            --rowBg: rgba(255,255,255,.8);
            --rowBorder: rgba(0,0,0,.08);
            --statusOk: #1a9987;
        }

        body.light .bg {
            background:
                    radial-gradient(900px 700px at 18% -10%, rgba(40,70,255,.18), transparent 60%),
                    radial-gradient(900px 700px at 100% 10%, rgba(0,194,255,.12), transparent 55%),
                    linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,0));
            opacity: .9;
        }

        body.light .btn-secondary {
            background: linear-gradient(135deg, rgba(16,17,20,.14), rgba(16,17,20,.06));
            border-color: rgba(0,0,0,.12);
        }
    </style>
</head>

<body>
<div class="bg"></div>

<div class="wrap">
    <div class="card">
        <div class="label" id="label">Доступный баланс</div>
        <div class="amount" id="amount">—</div>
        <div class="updated">Обновлено <span id="updatedAt">—</span></div>

        <div class="menu">
            <details id="extrasMenu">
                <summary class="btn btn-secondary">
                    <span class="menu-title">Дополнительно</span>
                </summary>
                <div class="menu-panel">
                    <button class="btn" id="refreshBtn">Обновить</button>
                    <button class="btn" id="connectBtn">Подключить YNAB</button>
                </div>
            </details>
        </div>

        <div class="hint" id="hint"></div>
    </div>

    <section class="transactions">
        <h2 class="transactions-title">Последние транзакции</h2>
        <div class="tx-list" id="txList"></div>
    </section>
</div>

<script>
    const tg = window.Telegram?.WebApp;

    const labelEl = document.getElementById('label');
    const amountEl = document.getElementById('amount');
    const updatedAtEl = document.getElementById('updatedAt');
    const hintEl = document.getElementById('hint');
    const refreshBtn = document.getElementById('refreshBtn');
    const txListEl = document.getElementById('txList');
    const connectBtn = document.getElementById('connectBtn');
    const extrasMenu = document.getElementById('extrasMenu');

    function setHint(text) {
        hintEl.textContent = text || "";
    }

    function applyTelegramTheme() {
        if (!tg) return;
        if (tg.colorScheme === "light") document.body.classList.add("light");
        else document.body.classList.remove("light");
    }

    function formatTimeHHMM(iso) {
        try {
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return "—";
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        } catch {
            return "—";
        }
    }

    function escapeHtml(value) {
        return String(value)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    function getIconText(title) {
        const t = (title || '').trim();
        return t ? escapeHtml(t[0].toUpperCase()) : '₽';
    }

    function renderTransactions(items) {
        const six = (items || []).slice(0, 6);

        if (six.length === 0) {
            txListEl.innerHTML = '<div class="tx-empty">Транзакций пока нет</div>';
            return;
        }

        txListEl.innerHTML = six.map((tx, index) => {
            const rawTitle = tx?.title || 'Транзакция';
            const rawSecondary = tx?.secondaryText || '';
            const rawAmount = tx?.amount || '0.00';

            const title = escapeHtml(rawTitle);
            const secondary = escapeHtml(rawSecondary);
            const amount = escapeHtml(rawAmount);

            return `
                <article class="tx-row">
                    <div class="tx-left">
                        <div class="tx-icon">${getIconText(rawTitle)}</div>
                        <div>
                            <p class="tx-title">${title}</p>
                            <p class="tx-sub">${secondary}</p>
                        </div>
                    </div>
                    <div class="tx-right">
                        <p class="tx-amount">${amount}</p>
                    </div>
                </article>
            `;
        }).join('');
    }

    async function postJson(url, body) {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { raw: text }; }
        if (!res.ok) throw { status: res.status, body: json };
        return json;
    }

    async function getJson(url, body) {
        const res = await fetch(url, {method:'POST', headers:{ 'Content-Type': 'application/json' }, body: JSON.stringify(body)});
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = []; }
        if (!res.ok) throw { status: res.status, body: json };
        return json;
    }

    async function callApi(endpoint) {
        try {
            if (!tg) {
                setHint("Открой Mini App внутри Telegram");
                return;
            }

            tg.ready();
            applyTelegramTheme();

            const initData = tg.initData || "";

            setHint("Загрузка…");

            const [data, transactions] = await Promise.all([
                postJson(endpoint, { initData }),
                getJson('/api/miniapp/transactions', { initData })
            ]);

            const fullText = data.balanceText || "";
            const parts = fullText.split(":");

            let label = "Доступный баланс";
            let amount = "—";

            if (parts.length >= 2) {
                label = parts[0].trim();
                amount = parts.slice(1).join(":").trim();
            }

            labelEl.textContent = label;
            amountEl.textContent = amount;
            updatedAtEl.textContent = formatTimeHHMM(data.updatedAt);
            renderTransactions(transactions);

            setHint("");

        } catch (e) {
            setHint("Ошибка при загрузке данных");
            renderTransactions([]);
        }
    }

    refreshBtn.addEventListener('click', () => {
        if (extrasMenu) extrasMenu.open = false;
        callApi('/api/miniapp/refresh');
    });
    connectBtn.addEventListener('click', async () => {
        if (extrasMenu) extrasMenu.open = false;
        if (!tg) return;
        const initData = tg.initData || '';
        try {
            const r = await postJson('/api/miniapp/oauth/start', { initData });
            if (r.url) window.location.href = r.url;
        } catch (e) { setHint('Не удалось начать OAuth'); }
    });
    callApi('/api/miniapp/balance');
</script>
</body>
</html>
