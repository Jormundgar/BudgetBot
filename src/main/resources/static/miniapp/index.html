<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Бюджет</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --bg: #0f1116;
            --text: #ffffff;
            --muted: rgba(255,255,255,.66);
            --muted2: rgba(255,255,255,.50);

            --cardBg1: rgba(255,255,255,.08);
            --cardBg2: rgba(255,255,255,.04);
            --cardBorder: rgba(255,255,255,.14);

            --shadow: 0 14px 34px rgba(0,0,0,.28);
            --radius: 20px;

            --btnBorder: rgba(255,255,255,.18);
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }

        body {
            margin: 0;
            padding: 18px;

            font-family:
                    "SF Pro Rounded",
                    "SF Pro Display",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    system-ui,
                    sans-serif;

            font-feature-settings: "kern" 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;

            color: var(--text);
            background: var(--bg);
        }

        /* Фон отдельным слоем */
        .bg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background:
                    radial-gradient(900px 700px at 18% -10%, rgba(40,70,255,.35), transparent 60%),
                    radial-gradient(900px 700px at 100% 10%, rgba(0,194,255,.26), transparent 55%),
                    linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,0));
            opacity: 1;
        }

        /* Контент */
        .wrap {
            position: relative;
            max-width: 560px;
            margin: 0 auto;
            padding: 0; /* без лишнего */
        }

        .card {
            border-radius: var(--radius);
            border: 1px solid var(--cardBorder);
            background:
                    linear-gradient(140deg, var(--cardBg1), var(--cardBg2)),
                    radial-gradient(120% 120% at 20% 10%, rgba(43,76,255,.40), transparent 55%),
                    radial-gradient(120% 120% at 85% 35%, rgba(0,194,255,.26), transparent 50%);
            box-shadow: var(--shadow);
            padding: 22px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .label {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--muted);
            letter-spacing: .1px;
        }

        .amount {
            margin: 0 0 14px 0;
            font-size: 34px;
            font-weight: 600;
            letter-spacing: -0.25px;
            line-height: 1.08;
        }

        .updated {
            margin: 0 0 18px 0;
            font-size: 13px;
            font-weight: 400;
            color: var(--muted2);
        }

        .btn {
            width: 100%;
            border-radius: 18px;
            padding: 14px;
            font-size: 15px;
            font-weight: 500;
            border: 1px solid var(--btnBorder);
            background: linear-gradient(135deg, rgba(43,76,255,.78), rgba(0,194,255,.52));
            color: #fff;
            cursor: pointer;
            user-select: none;
            transition: transform .08s ease, opacity .12s ease;
        }
        .btn:active { transform: scale(.985); opacity: .92; }

        .hint {
            margin-top: 12px;
            font-size: 12px;
            color: var(--muted2);
            min-height: 16px; /* чтобы не прыгало */
        }

        details {
            margin-top: 14px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.04);
            overflow: hidden;
        }
        details > summary {
            cursor: pointer;
            padding: 12px 14px;
            font-size: 12px;
            font-weight: 500;
            color: rgba(255,255,255,.68);
            list-style: none;
        }
        details[open] > summary { border-bottom: 1px solid rgba(255,255,255,.08); }

        pre {
            margin: 0;
            padding: 12px 14px 14px;
            font-size: 12px;
            color: rgba(255,255,255,.72);
            white-space: pre-wrap;
        }

        /* Light theme */
        body.light {
            --bg: #f4f6f9;
            --text: #101114;
            --muted: rgba(16,17,20,.62);
            --muted2: rgba(16,17,20,.48);

            --cardBg1: rgba(255,255,255,.92);
            --cardBg2: rgba(255,255,255,.86);
            --cardBorder: rgba(0,0,0,.08);

            --shadow: 0 14px 30px rgba(0,0,0,.08);
            --btnBorder: rgba(0,0,0,.08);
        }

        body.light .bg {
            background:
                    radial-gradient(900px 700px at 18% -10%, rgba(40,70,255,.18), transparent 60%),
                    radial-gradient(900px 700px at 100% 10%, rgba(0,194,255,.12), transparent 55%),
                    linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,0));
            opacity: .9;
        }

        body.light details {
            border-color: rgba(0,0,0,.08);
            background: rgba(0,0,0,.03);
        }
        body.light details > summary { color: rgba(16,17,20,.62); }
        body.light pre { color: rgba(16,17,20,.72); }
    </style>
</head>

<body>
<div class="bg"></div>

<div class="wrap">
    <div class="card">
        <div class="label" id="label">Доступный баланс</div>
        <div class="amount" id="amount">—</div>
        <div class="updated">Обновлено <span id="updatedAt">—</span></div>

        <button class="btn" id="refreshBtn">Обновить</button>

        <div class="hint" id="hint"></div>

        <details>
            <summary>debug</summary>
            <pre id="debug">{}</pre>
        </details>
    </div>
</div>

<script>
    const tg = window.Telegram?.WebApp;

    const labelEl = document.getElementById('label');
    const amountEl = document.getElementById('amount');
    const updatedAtEl = document.getElementById('updatedAt');
    const hintEl = document.getElementById('hint');
    const debugEl = document.getElementById('debug');
    const refreshBtn = document.getElementById('refreshBtn');

    function setHint(text) {
        hintEl.textContent = text || "";
    }

    function setDebug(obj) {
        debugEl.textContent = JSON.stringify(obj, null, 2);
    }

    function applyTelegramTheme() {
        if (!tg) return;
        if (tg.colorScheme === "light") document.body.classList.add("light");
        else document.body.classList.remove("light");
    }

    function formatTimeHHMM(iso) {
        try {
            const d = new Date(iso);
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        } catch {
            return "—";
        }
    }

    async function postJson(url, body) {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { raw: text }; }
        if (!res.ok) throw { status: res.status, body: json };
        return json;
    }

    async function callApi(endpoint) {
        try {
            if (!tg) {
                setHint("Открой Mini App внутри Telegram");
                return;
            }

            tg.ready();
            applyTelegramTheme();

            const initData = tg.initData || "";

            setHint("Загрузка…");

            const data = await postJson(endpoint, { initData });

            const fullText = data.balanceText || "";
            const parts = fullText.split(":");

            let label = "Доступный баланс";
            let amount = "—";

            if (parts.length >= 2) {
                label = parts[0].trim();
                amount = parts.slice(1).join(":").trim();
            }

            labelEl.textContent = label;
            amountEl.textContent = amount;
            updatedAtEl.textContent = formatTimeHHMM(data.updatedAt);

            setHint(""); // ничего не показываем если всё ок
            setDebug({ endpoint, response: data });

        } catch (e) {
            setHint("Ошибка (см. debug)");
            setDebug(e);
        }
    }

    refreshBtn.addEventListener('click', () => callApi('/api/miniapp/refresh'));
    callApi('/api/miniapp/balance');
</script>
</body>
</html>